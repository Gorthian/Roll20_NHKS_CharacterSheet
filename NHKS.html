<!--
	EDITED by 			Gorthian
	Version				0.1
	Letzte Änderung		2022-03-06
	
	GitHub				https://github.com/Gorthian/Roll20_NHKS_CharacterSheet
	Wiki				https://github.com/Gorthian/Roll20_NHKS_CharacterSheet/wiki
	Bugs & Issues		https://github.com/Gorthian/Roll20_NHKS_CharacterSheet/issues
//-->

<!-- Sheet //-->
<input type="hidden" class="sheet-tabstoggle" name="attr_sheetTab"  value="actor"  />
<div class="sheet-wrapper sheet-NHKS">
	<div class="sheet-menu">
		<button type="action" name="act_actor"><span data-i18n="actor"></span></button>
    	<button type="action" name="act_role"><span data-i18n="role"></span></button>
	</div>
	<div class="sheet-content">
		<div class="sheet-actor">
			<div class="sheet-actor-sheet">
				<div class="sheet-actor-attributes">
					<h1><span data-i18n="attributes-and-descriptions"></span></h1>
					<div class="sheet-actor-attributes-content">
						<div class="sheet-actor-attributes-left">
							<span class="sheet-input-line"><span class="sheet-label" data-i18n="name"></span><input type="text" name="attr_character_name" /></span>
							<span class="sheet-input-line"><span class="sheet-label" data-i18n="gender"></span><input type="text" name="attr_actor_gender" /></span>
							<span class="sheet-input-line"><span class="sheet-label" data-i18n="age"></span><input type="text" name="attr_actor_age" /></span>
							<span class="sheet-input-line"><span class="sheet-label" data-i18n="weight"></span><input type="text" name="attr_actor_weight" /></span>
							<span class="sheet-input-line"><span class="sheet-label" data-i18n="size"></span><input type="text" name="attr_actor_weight" /></span>
							<span class="sheet-input-line"><span class="sheet-label" data-i18n="nationality"></span><input type="text" name="attr_actor_nationality" /></span>
							<p><span class="sheet-label" data-i18n="stature"></span><textarea name="attr_actor_stature" value=""></textarea></p>
							<p><span class="sheet-label" data-i18n="description"></span><textarea name="attr_actor_description" value=""></textarea></p>
							<div class="sheet-actor-attributes-values">
								<div class="sheet-actor-attr-kno sheet-input-line">
									<span class="sheet-label">
										<span class="sheet-attr-short" data-i18n="knowledge-short"></span><br/>
										<span class="sheet-attr-full" data-i18n="knowledge"></span>
									</span>
									<input class="sheet-attribute-value" type="number" name="attr_knowledge" />
								</div>
								<div class="sheet-actor-attr-str sheet-input-line">
									<span class="sheet-label">
										<span class="sheet-attr-short" data-i18n="strength-short"></span><br/>
										<span class="sheet-attr-full" data-i18n="strength"></span>
									</span>
									<input class="sheet-attribute-value" type="number" name="attr_strength" />
								</div>
								<div class="sheet-actor-attr-col sheet-input-line">
									<span class="sheet-label">
										<span class="sheet-attr-short" data-i18n="coolness-short"></span><br/>
										<span class="sheet-attr-full" data-i18n="coolness"></span>
									</span>
									<input class="sheet-attribute-value" type="number" name="attr_coolness" />
								</div>
								<div class="sheet-actor-attr-sta sheet-input-line">
									<span class="sheet-label">
										<span class="sheet-attr-short" data-i18n="stamina-short"></span><br/>
										<span class="sheet-attr-full" data-i18n="stamina"></span>
									</span>
									<input class="sheet-attribute-value" type="number" name="attr_stamina" />
								</div>
								<div class="sheet-actor-attr-chi sheet-input-line">
									<span class="sheet-label">
										<span class="sheet-attr-short" data-i18n="chi-short"></span><br/>
										<span class="sheet-attr-full" data-i18n="chi"></span>
									</span>
									<input class="sheet-attribute-value" type="number" name="attr_chi" />
								</div>
								<div class="sheet-actor-attr-dex sheet-input-line">
									<span class="sheet-label">
										<span class="sheet-attr-short" data-i18n="dexterity-short"></span><br/>
										<span class="sheet-attr-full" data-i18n="dexterity"></span>
									</span>
									<input class="sheet-attribute-value" type="number" name="attr_dexterity" />
								</div>
							</div>
						</div>
						<div class="sheet-actor-attributes-right">
							<div class="sheet-actor-attr-hitpoints sheet-input-line">
								<span class="sheet-attr-name" data-i18n="hitpoints"></span><br/>
								<span class="sheet-attr-desc" data-i18n="hitpoints-desc"></span><br/>								
								<input type="number" name="attr_hitpoints_current" /> / <input type="number" name="attr_hitpoints_max" class="sheet-no-arrows" READONLY />
							</div>
							<div class="sheet-actor-attr-chipoints sheet-input-line">
								<span class="sheet-attr-name" data-i18n="chipoints"></span><br/>
								<span class="sheet-attr-desc" data-i18n="chipoints-desc"></span><br/>							
								<input type="number" name="attr_chipoints_current" /> / <input type="number" name="attr_chipoints_max" class="sheet-no-arrows" READONLY />
							</div>
							<div class="sheet-actor-attr-famepoints sheet-input-line">
								<span class="sheet-attr-name" data-i18n="famepoints"></span><br/>
								<span class="sheet-attr-desc" data-i18n="famepoints-desc"></span><br/>
								<input type="number" name="attr_famepoints" />
							</div>
							<div class="sheet-actor-attr-awardpoints sheet-input-line">
								<span class="sheet-attr-name" data-i18n="awardpoints"></span><br/>
								<span class="sheet-attr-desc" data-i18n="awardpoints-desc"></span><br/>						
								<input type="number" name="attr_awardpoints" />
							</div>
							<div class="sheet-actor-attr-initiative sheet-input-line">
								<span class="sheet-attr-name" data-i18n="initiative"></span><br/>
								<span class="sheet-attr-desc" data-i18n="initiative-desc"></span><br/>						
								<input type="number" name="attr_initiative" class="sheet-no-arrows" READONLY />
							</div>
							<div class="sheet-actor-attr-melee-attack sheet-input-line">
								<span class="sheet-attr-name" data-i18n="melee-attack"></span><br/>
								<span class="sheet-attr-desc" data-i18n="melee-attack-desc"></span><br/>						
								<input type="number" name="attr_melee_attack" class="sheet-no-arrows" READONLY />
							</div>
							<div class="sheet-actor-attr-melee-defense sheet-input-line">
								<span class="sheet-attr-name" data-i18n="melee-defense"></span><br/>
								<span class="sheet-attr-desc" data-i18n="melee-defense-desc"></span><br/>							
								<input type="number" name="attr_melee_defense" class="sheet-no-arrows" READONLY />
							</div>							
							<div class="sheet-actor-attr-melee-damage sheet-input-line">
								<span class="sheet-attr-name" data-i18n="melee-damage"></span><br/>
								<span class="sheet-attr-desc" data-i18n="melee-damage-desc"></span><br/>						
								<input type="number" name="attr_melee_damage" class="sheet-no-arrows" READONLY />
							</div>
							<div class="sheet-actor-attr-ranged-attack sheet-input-line">
								<span class="sheet-attr-name" data-i18n="ranged-attack"></span><br/>
								<span class="sheet-attr-desc" data-i18n="ranged-attack-desc"></span><br/>							
								<input type="number" name="attr_ranged_attack" class="sheet-no-arrows" READONLY />
							</div>							
							<div class="sheet-actor-attr-ranged-damage sheet-input-line">
								<span class="sheet-attr-name" data-i18n="ranged-damage"></span><br/>
								<span class="sheet-attr-desc" data-i18n="ranged-damage-desc"></span><br/>							
								<input type="number" name="attr_ranged_damage" class="sheet-no-arrows" READONLY />
							</div>
						</div>						
					</div>
				</div>
				<div class="sheet-actor-skills">
					<h1><span data-i18n="skills"></span></h1>
					<div class="row">	
						<div class="col">
							<span data-i18n="acrobatic"></span>
						</div>
						<div class="col">
							<span>+4</span>
						</div>
						<div class="col">
							<select name="attr_skill_attribute_acrobatic">
								<option value="dexterity" data-i18n="dexterity-short"></option>
							</select>
						</div>
						<div class="col">
							<span class="sheet-skill-sum" name="attr_skill_sum_acrobatic"></span>
						</div>
					</div>
					<div class="row">
						<div class="col">
							<span data-i18n="athletic"></span>
						</div>
						<div class="col">
							<span>+3</span>
						</div>
						<div class="col">
							<select name="attr_skill_attribute_athletic">
								<option value="strength" data-i18n="strength-short"></option>
								<option value="stamina" data-i18n="stamina-short"></option>
							</select>
						</div>
						<div class="col">
							<span class="sheet-skill-sum" name="attr_skill_sum_athletic"></span>
						</div>
					</div>
					<div class="row">
						<div class="col">
							<span data-i18n="dodge"></span>
						</div>
						<div class="col">
							<span>+5</span>
						</div>
						<div class="col">
							<select name="attr_skill_attribute_dodge">
								<option value="dexterity" data-i18n="dexterity-short"></option>
							</select>
						</div>
						<div class="col">
							<span class="sheet-skill-sum" name="attr_skill_sum_dodge"></span>
						</div>
					</div>
					<div class="row">
						<div class="col">
							<span data-i18n="steer"></span>
						</div>
						<div class="col">
							<span>+2</span>
						</div>
						<div class="col">
							<select name="attr_skill_attribute_steer">
								<option value="knowledge" data-i18n="knowledge-short"></option>
								<option value="dexterity" data-i18n="dexterity-short"></option>
							</select>
						</div>
						<div class="col">
							<span class="sheet-skill-sum" name="attr_skill_sum_steer"></span>
						</div>
					</div>
					<div class="row">
						<div class="col">
							<span data-i18n="intimidate-persuade"></span>
						</div>
						<div class="col">
							<span>+2</span>
						</div>
						<div class="col">
							<select name="attr_skill_attribute_persuade">
								<option value="coolness" data-i18n="coolness-short"></option>
								<option value="strength" data-i18n="strength-short"></option>
							</select>
						</div>
						<div class="col">
							<span class="sheet-skill-sum" name="attr_skill_sum_persuade"></span>
						</div>
					</div>
				</div>
				<div class="sheet-actor-advantages">
					<h1><span data-i18n="advantages-and-disadvantages"></span></h1>
				</div>
				<div class="sheet-actor-movies">
					<h1><span data-i18n="movies"></span></h1>
				</div>
				<div class="sheet-actor-martialarts">
					<h1><span data-i18n="martialarts"></span></h1>
				</div>
				<div class="sheet-actor-awards">
					<h1><span data-i18n="awards"></span></h1>
				</div>
				<div class="sheet-actor-misc">
					<h1><span data-i18n="misc"></span></h1>
				</div>
			</div>			
		</div>
		<div class="sheet-role">
			<span>Rolle</span>
		</div>		
	</div>
	<div class="sheet-footer">
		Created by Gorthian | Supported by Hitdice | Copyright by Black Mask Verlag
		<br/>More Infos: https://github.com/Gorthian/Roll20_NHKS_CharacterSheet
	</div>	
</div>


<!-- SheetWorker //-->
<script type="text/worker">
	
	/* Globale Variablen -- Start */
	const iMinAttributeValue = 5;
	const iMaxAttributeValue = 10;
	const aActorAttributes = ["strength","stamina","dexterity","knowledge","coolness","chi"];
	const aActorSkills = ["acrobatic","athletic","dodge","steer","persuade"];
	/* Globale Variablen -- Ende */
	
	/* Tab-Wechsel */
	const buttonlist = ["actor","role"];
    buttonlist.forEach(button => {
        on(`clicked:${button}`, function() {
            setAttrs({
                sheetTab: button
            });
        });
    });
	
	/* Event-Listener -- Start */
	on("sheet:opened", function () {
		recalcValues();
	});
	
	/* Änderungen an Attributen */
	aActorAttributes.forEach(sAttribute => {
        on(`change:${sAttribute}`, function() {
			console.log("[CHANGE] " + sAttribute);
            changedAttribute(sAttribute);
        });
    });
	
	/* Änderungen an Fertigkeiten */
	aActorSkills.forEach(sSkill => {
        on(`change:skill_attribute_${sSkill}`, function() {
			console.log("[CHANGE] " + sSkill);
            recalcSkill(sSkill);
        });
    });	
	/* Event-Listener -- Ende */
	
		
	/* Funktionen -- Start */
	function recalcValues() {
		console.log("recalcValues");
		aActorAttributes.forEach(sAttribute => {
			changedAttribute(sAttribute);
		});		
	}
	
	function changedAttribute(sAttribute) {
		console.log("[changedAttribute] " + sAttribute);
		
		getAttrs([sAttribute], function (values){
			let iAttribute = parseInt(values[sAttribute]||iMinAttributeValue);
			let aAttributes = {};
			
			// Auf Min/Max prüfen
			if (iAttribute < iMinAttributeValue ) {
				iAttribute = iMinAttributeValue;
			} else if (iAttribute > iMaxAttributeValue ) {
				iAttribute = iMaxAttributeValue;
			}
			aAttributes[sAttribute] = iAttribute;
			setAttrs(aAttributes);
			
			switch (sAttribute) {
				case "strength":
					recalcMeleeAttack();
					recalcMeleeDefense();
					recalcSkill("athletic");
					recalcSkill("persuade");	
					break;
				case "stamina":
					recalcHitpoints();
					recalcSkill("athletic");
					break;
				case "dexterity":
					recalcMeleeDefense();
					recalcRangedAttack();
					recalcSkill("acrobatic");
					recalcSkill("dodge");
					recalcSkill("steer");
					break;
				case "knowledge":
					recalcSkill("steer");
					break;
				case "coolness":
					recalcInitiative();
					recalcSkill("persuade");
					break;
				case "chi":
					recalcMeleeAttack();
					recalcChipoints();
					recalcMeleeDefense();
					recalcRangedAttack();
					break;
				default:
			}			
		});
	}
	
	function recalcInitiative() {
		console.log("recalcInitiative");
		getAttrs(["coolness"], function (values){
			let iCoolness = parseInt(values["coolness"]||0);
			let iInitiative = iCoolness;
			let aAttributes = {};
			
			aAttributes["initiative"] = iInitiative;
			
			setAttrs(aAttributes);		
		});
	}
	
	function recalcHitpoints() {
		console.log("recalcHitpoints");
		getAttrs(["stamina"], function (values){
			let iStamina = parseInt(values["stamina"]||0);
			let iHitpoints = (iStamina + 4) * 10;
			let aAttributes = {};
			
			aAttributes["hitpoints_max"] = iHitpoints;
			
			setAttrs(aAttributes);		
		});
	}
	
	function recalcChipoints() {
		console.log("recalcChipoints");
		getAttrs(["chi"], function (values){
			let iChi = parseInt(values["chi"]||0);
			let iChipoints = iChi * 10;
			let aAttributes = {};
			
			aAttributes["chipoints_max"] = iChipoints;
			
			setAttrs(aAttributes);		
		});
	}
	
	function recalcMeleeAttack() {
		console.log("recalcMeleeAttack");
		getAttrs(["chi","strength"], function (values){
			let iChi = parseInt(values["chi"]||0);
			let iStrength = parseInt(values["strength"]||0);
			let iMeleeAttack = Math.round((iStrength * 2 + iChi) / 3);
			let aAttributes = {};
			
			aAttributes["melee_attack"] = iMeleeAttack;
			
			setAttrs(aAttributes);		
		});
	}
	
	function recalcMeleeDefense() {
		console.log("recalcMeleeDefense");
		getAttrs(["chi","strength","dexterity"], function (values){
			let iChi = parseInt(values["chi"]||0);
			let iStrength = parseInt(values["strength"]||0);
			let iDexterity = parseInt(values["dexterity"]||0);
			let iMeleeDefense = Math.round((iStrength + iDexterity + iChi) / 3);
			let aAttributes = {};
			
			aAttributes["melee_defense"] = iMeleeDefense;
			
			setAttrs(aAttributes);		
		});
	}
	
	function recalcRangedAttack() {
		console.log("recalcRangedAttack");
		getAttrs(["chi","dexterity"], function (values){
			let iChi = parseInt(values["chi"]||0);
			let iDexterity = parseInt(values["dexterity"]||0);
			let iRangedAttack = Math.round((iDexterity * 2 + iChi) / 3);
			let aAttributes = {};
			
			aAttributes["ranged_attack"] = iRangedAttack;
			
			setAttrs(aAttributes);		
		});
	}

	function recalcSkill(sSkill) {
		console.log("recalcSkill " + sSkill );
		getAttrs(["skill_attribute_" +sSkill], function (values){
			let sAttribute = values["skill_attribute_" + sSkill];
			console.log("-- useAttribute " + sAttribute );

			getAttrs([sAttribute], function (values){
				let iAttribute = parseInt(values[sAttribute]);
				let iSkillModifier = 0;
				let aAttributes = {};
	
				switch(sSkill) {
					case "acrobatic":
						iSkillModifier = 4;
						  break;
					case "athletic":
						 iSkillModifier = 3;
						break;
					case "dodge":
						iSkillModifier = 5;
					  	break;
					case "steer":
						iSkillModifier = 2;
						break;
					case "persuade":
						iSkillModifier = 2;
						break;
					default:
						iSkillModifier = 0;
				}
				console.log("-- " + sSkill + " Modifier for " + sAttribute + " : " + iSkillModifier );
				aAttributes["skill_sum_" + sSkill] = iAttribute + iSkillModifier;
				setAttrs(aAttributes);				
			});
		});
	}
	
	/* Funktionen -- Ende */
</script>